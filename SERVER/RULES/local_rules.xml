<!-- Local rules -->
<!-- Modify it at your will. -->
<!-- Copyright (C) 2015, Wazuh Inc. -->

<group name="ossec,syslog,sshd,">
  <rule id="100001" level="3">
    <if_sid>5716,5758,5760,5762,2502</if_sid>
    <match>^Failed|^error:PAM:Authentication|^error:maximum authentication attempts exceeded|Failed password|Failed keyboard|authentication error|Connection reset|more authentication failures;|REPEATED login failures</match>
    <description>SSH Brute Force Attack Detected/Too many attempts were missed</description>
    <group>authentication_failed,gdpr_IV_35.7.d,gdpr_IV_32.2,gpg13_7.1,hipaa_164.312.b,nist_800_53_AU.14,nist_800_53_AC.7,pci_dss_10.2.4,pci_dss_10.2.5,tsc_CC6.8,tsc_CC6.8,tsc_CC7.3,</group>
  </rule>

  <rule id="100002" level="6">
    <if_sid>92657,92052</if_sid>
    <description>Authentication using NTLM/Possible Pass the Hash Attack Detected</description>
    <group>authentication_success,pci_dss_10.2.5,gpg13_13_7_1,gpg13_7_2,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AC.7,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
</group>





<group name="syscheck">
  <rule id="100003" level="8">
    <if_sid>553</if_sid>
    <field name="process_name">explorer.exe$</field>
    <field name="uname">Firdo$</field>
    <match>deleted</match>
    <description>The user "$(uname)" deleted a monitored file with File Explorer</description>
    <mitre>
      <id>T1070.004</id>
      <id>T1485</id>
    </mitre>
  </rule>
</group>


<group name="integrity, dlp,">
  <rule id="100102" level="5">
     <if_sid>60103</if_sid>
     <field name="win.system.eventID">4663</field>
     <description>Mitre ATT&CK T1119, Windows User attempted to access an object</description>
     <options>no_full_log</options>
  </rule>

  <rule id="100103" level="5">
     <if_sid>100102</if_sid>
     <field name="win.eventdata.accessList">%%4416</field>
     <description>Mitre ATT&CK T1119, Windows User attempted to access an object - Read Data</description>
  </rule>

  <rule id="100104" level="5">
     <if_sid>100102</if_sid>
     <field name="win.eventdata.accessList">%%4417</field>
     <description>Mitre ATT&CK T1119, Windows User attempted to access an object - Write Data</description>
  </rule>

  <rule id="100105" level="5">
     <if_sid>100102</if_sid>
     <field name="win.eventdata.accessList">%%4418</field>
     <description>Mitre ATT&CK T1119, Windows User attempted to access an object - Append Data</description>
  </rule>
</group>


<!-- USB DETECTOR -->

<group name="windows-usb-detect,dlp">
  <rule id="111000" level="7">
    <if_sid>60227</if_sid>
    <field name="win.system.eventID">^6416$</field>
    <match>USBSTOR\\Disk</match>
    <options>no_full_log</options>
    <description>Windows: A PNP device $(win.eventdata.deviceDescription) was connected to $(win.system.computer)</description>
  </rule>
</group>



                        <!-- Virustotal -->
<group name="Virus/Malware">
  <rule id="100092" level="12">
      <if_sid>657</if_sid>
      <match>Successfully removed threat</match>
      <description>$(parameters.program) removed threat located at monitored directory</description>
  </rule>

  <rule id="100093" level="12">
    <if_sid>657</if_sid>
    <match>Error removing threat</match>
    <description>Error removing threat located at $(parameters.alert.data.virustotal.source.file)</description>
  </rule>

  <rule id="100206" level="12">
    <if_sid>657</if_sid>
    <match>Successfully removed threat</match>
    <description>$(parameters.program) chaveloack threat removed located at $(parameters.alert.data.virustotal.source.file)</description>
    <mitre>
      <id>T1107</id>
      <id>T1485</id>
    </mitre>
  </rule>

  <rule id="100207" level="12">
    <if_sid>657</if_sid>
    <match>Error removing threat</match>
    <description>Error chavecload threat removing located at $(parameters.alert.data.virustotal.source.file)</description>
  </rule>

</group>
                                <!-- Malware -->

<group name="malware,">
  <rule id="110002" level="13">
    <if_sid>554, 550</if_sid>
    <list field="md5" lookup="match_key">etc/lists/malware-hashes</list>
    <description>File with known malware hash detected: $(file)</description>
    <mitre>
      <id>T1204.002</id>
    </mitre>
  </rule>

  <rule id="110003" level="5">
    <if_sid>110002</if_sid>
    <field name="file" type="pcre2">(?i)[c-z]:</field>
    <description>A file - $(file) - in the malware blacklist was added to the system.</description>
  </rule>

  <rule id="110004" level="7">
    <if_sid>659</if_sid>
    <match>Successfully removed threat</match>
    <description>$(parameters.program): Successfully removed threat $(parameters.alert.syscheck.path) whose MD5 hash appears in a malware blacklist.</description>
  </rule>
  <rule id="110005" level="7">
    <if_sid>659</if_sid>
    <match>Error removing threat</match>
    <description>$(parameters.program): Error removing threat $(parameters.alert.syscheck.path) whose MD5 hash appears in a malware blacklist.</description>
  </rule>

</group>





                                <!-- YARA FIM -->

<group name="syscheck,">
  <rule id="100300" level="7">
    <if_sid>550</if_sid>
    <field name="file">/home/</field>
    <description>File modified in /home/ directory.</description>
  </rule>
  <rule id="100301" level="7">
    <if_sid>554</if_sid>
    <field name="file">/home/</field>
    <description>File added to /home/ directory.</description>
  </rule>
</group>

<group name="syscheck,">
  <rule id="100303" level="7">
    <if_sid>550</if_sid>
    <field name="file">Downloads</field>
    <description>File modified in the sensitive_file folder</description>
  </rule>
  <rule id="100304" level="7">
    <if_sid>554</if_sid>
    <field name="file">Downloads</field>
    <description>File added in the sensitive_file folder.</description>
  </rule>
  <rule id="100305" level="7">
    <if_sid>550</if_sid>
    <field name="file">sensitive_file</field>
    <description>File modified in the sensitive_file folder</description>
  </rule>
  <rule id="100306" level="7">
    <if_sid>554</if_sid>
    <field name="file">sensitive_file</field>
    <description>File added in the sensitive_file folder.</description>
  </rule>
</group>

<group name="Sentinel AI,">
  <rule id="108000" level="3">
    <decoded_as>Sentinel AI decoder</decoded_as>
    <description>Yara grouping rule</description>
  </rule>

  <rule id="108001" level="12">
    <if_sid>108000</if_sid>
    <match>Sentinel AI: INFO - Scan result: </match>
    <description>File "$(yara_scanned_file)" is a positive match. Sentinel AI rule: "$(yara_rule)"</description>
  </rule>

    <rule id="108002" level="5">
    <if_sid>108000</if_sid>
    <field name="Sentinel_AI.file_deleted">\.</field>
    <description>Sentinel AI: Active response successfully removed malicious file "$(Sentinel_AI.file_deleted)"</description>
  </rule>

  <rule id="108003" level="12">
    <if_sid>108000</if_sid>
    <field name="Sentinel_AI.file_not_deleted">\.</field>
    <description>Sentinel AI: Active response unable to delete malicious file "$(Sentinel_AI.file_not_deleted)"</description>
  </rule>
</group>


                        <!--AbuseIPDB SSH Authentication from Public IP -->

<group name="local,syslog,sshd,">
  <rule id="100004" level="5">
    <if_sid>5716</if_sid>
    <match type="pcre2">\b(?!(10)|192\.168|172\.(2[0-9]|1[6-9]|3[0-1])|(25[6-9]|2[6-9][0-9]|[3-9][0-9][0-9]|99[1-9]))[0-9]{1,3}\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)</match>
    <description>sshd: Authentication failed from a public IP address $(srcip).</description>
    <group>authentication_failed,authentication_success,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>

  <rule id="100005" level="5">
    <if_sid>5715</if_sid>
    <match type="pcre2">\b(?!(10)|192\.168|172\.(2[0-9]|1[6-9]|3[0-1])|(25[6-9]|2[6-9][0-9]|[3-9][0-9][0-9]|99[1-9]))[0-9]{1,3}\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)</match>
    <description>sshd: Authentication succeeded from a public IP address $(srcip).</description>
    <group>authentication_failed,authentication_success,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>

  <rule id="100006" level="10">
    <field name="abuseipdb.source.rule" type="pcre2">^100002$</field>
    <field name="abuseipdb.abuse_confidence_score" type="pcre2" negate="yes">^0$</field>
    <description>AbuseIPDB: SSH Authentication failed from a public IP address $(abuseipdb.source.srcip) with $(abuseipdb.abuse_confidence_score)% confidence of abuse.</description>
    <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>

  <rule id="100007" level="14">
    <field name="abuseipdb.source.rule" type="pcre2">^100003$</field>
    <field name="abuseipdb.abuse_confidence_score" type="pcre2" negate="yes">^0$</field>
    <description>AbuseIPDB: SSH Authentication succeeded from a public IP address $(abuseipdb.source.srcip) with $(abuseipdb.abuse_confidence_score)% confidence of abuse.</description>
    <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>
</group>





                                <!-- Disabling user Account -->

<group name="pam,syslog,">
  <rule id="120100" level="10" frequency="3" timeframe="120">
    <if_matched_sid>5503</if_matched_sid>
    <description>Possible password guess on $(dstuser): 3 failed logins in a short period of time</description>
    <mitre>
      <id>T1110</id>
    </mitre>
  </rule>
</group>


                  <!-- blocking a known malicious actor -->
<group name="attack,">
  <rule id="100100" level="10">
     <if_group>web|attack|attacks</if_group>
     <list field="srcip" lookup="address_match_key">etc/lists/blacklist-alienvault</list>
     <description>IP address found in AlienVault reputation database.</description>
  </rule>
</group>


                <!----------------- DATALOASS ----------------->

<!-- Large file copy operations -->
<group name="dlp,data_exfiltration,">
  <rule id="100500" level="10">
    <if_sid>550</if_sid>
    <match>copied|moved|transferred</match>
    <regex>\.zip|\.rar|\.7z</regex>
    <description>Large archive file operation detected</description>
  </rule>

  <!-- Sensitive file access -->
  <rule id="100501" level="12">
    <if_sid>550</if_sid>
    <match>\.xlsx|\.csv|\.pdf</match>
    <description>Sensitive file operation detected</description>
  </rule>

  <!-- USB device connection -->
  <rule id="100502" level="10">
    <match>USB Mass Storage Device connected</match>
    <description>USB storage device connected</description>
  </rule>

  <!-- Document printing -->
  <rule id="100503" level="8">
    <match>print job|printing|printed</match>
    <regex>confidential|restricted</regex>
    <description>Sensitive document print detected</description>
  </rule>
</group>




<group name="windows,">
  <rule id="100150" level="0">
    <if_sid>67027</if_sid>
    <match>Process Name:\s*C:\\Windows\\System32\\svchost.exe</match>
    <description>Ignore benign svchost.exe process creation</description>
  </rule>

  <rule id="100151" level="0">
    <if_sid>67027</if_sid>
    <match>Process Name:\s*C:\\Windows\\explorer.exe</match>
    <description>Ignore benign explorer.exe process creation</description>
  </rule>


  <rule id="100152" level="10">
    <if_sid>67027</if_sid>
    <match>cmd.exe|powershell.exe|certutil.exe|wget.exe|curl.exe</match>
    <description>Potential suspicious process creation</description>
  </rule>

  <rule id="100153" level="0">
    <if_sid>67027</if_sid>
    <field name="win.system.eventID">^4688$</field>
    <description>Suppressed all process creation events (4688)</description>
  </rule>
</group>
